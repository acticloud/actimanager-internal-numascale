import sqlite3

#This is an in-memory sql representation of the numa topology of the system
class Numadistance(object):

    def __init__(self):
        self.db = sqlite3.connect(":memory:")
        self.createTable()

    def __exit__(self, exc_type, exc_value, traceback):
        self.db.close()

    def getNumaDistance(self, node1, node2):
        column = "n" + str(node2)
        dist = self.execute_db("SELECT {cn} FROM {tn} WHERE {nf} = {value}  " \
                               .format(cn=column, tn='numadistance', nf='idx', value=node1))

        return dist[0][0]

    def execute_db(self, *args):
        cur = self.db.cursor()
        data = True
        try:
            args = list(args)
            args[0] = args[0].replace("%s", "?").replace(" update "," `update` ")
            args = tuple(args)
            cur.execute(*args)
            arg = args[0].split()[0].lower()
            if arg in ["update", "insert", "delete", "create"]: self.db.commit()
        except Exception as why:
            print why
            data = False
            self.db.rollback()
        self.db.commit()
        return cur.fetchall()

    def createTable(self):
        #TODO: Hardcoded to create an in-memory table of the UMEA numascale system. Needs to be modified to run on other systems.
        #A better solution would be to read this from an xml file or possibly sniff the numactl --hardware output

        self.execute_db("CREATE TABLE {tn} ({nf} {ft} PRIMARY KEY) "\
                        .format(tn='numadistance', nf='idx', ft='INTEGER'))

        insertString = "INSERT INTO numadistance (idx"

        for n in range (36):
            self.execute_db("ALTER TABLE {tn} ADD COLUMN '{cn}' {ct}" \
                            .format(tn='numadistance', cn='n'+str(n), ct='INTEGER'))
            insertString += ", n" + str(n)

        #UGH, now we to this 36 times (6*6) (with different values)
        #ServerNode 1
        valueString = """ VALUES ('0', '10', '16', '16', '22', '16', '22', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '200', 
                                  '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200')"""
        self.execute_db(insertString+")"+valueString)
        valueString = """ VALUES ('1', '16', '10', '22', '16', '16', '22', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '200', '200', 
                                  '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200 ')"""
        self.execute_db(insertString+")"+valueString)
        valueString = """ VALUES ('2', '16', '22', '10', '16', '16', '22', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '200', 
                                  '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200')"""
        self.execute_db(insertString+")"+valueString)
        valueString = """ VALUES ('3', '22', '16', '16', '10', '22', '16', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '200', 
                                  '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200')"""
        self.execute_db(insertString+")"+valueString)
        valueString = """ VALUES ('4', '16', '16', '16', '22', '10', '16', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '200', 
                                  '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200')"""
        self.execute_db(insertString+")"+valueString)
        valueString = """ VALUES ('5', '22', '22', '22', '16', '16', '10', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '200',
                                  '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200')"""
        self.execute_db(insertString+")"+valueString)

        # ServerNode 2
        valueString = """ VALUES ('6', '160', '160', '160', '160', '160', '160', '10', '16', '16', '22', '16', '22', '200', '200', '200', '200', '200', '200', '160', 
                                  '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('7', '160', '160', '160', '160', '160', '160', '16', '10', '22', '16', '16', '22', '200', '200', '200', '200', '200', '200', '160', 
                                  '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('8', '160', '160', '160', '160', '160', '160', '16', '22', '10', '16', '16', '22', '200', '200', '200', '200', '200', '200', '160', 
                                  '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('9', '160', '160', '160', '160', '160', '160', '22', '16', '16', '10', '22', '16', '200', '200', '200', '200', '200', '200', '160', 
                                  '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('10', '160', '160', '160', '160', '160', '160', '16', '16', '16', '22', '10', '16', '200', '200', '200', '200', '200', '200', '160', 
                                  '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('11', '160', '160', '160', '160', '160', '160', '22', '22', '22', '16', '16', '10', '200', '200', '200', '200', '200', '200', '160', 
                                  '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160')"""
        self.execute_db(insertString + ")" + valueString)

        # ServerNode 3
        valueString = """ VALUES ('12', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', '10', '16', '16', '22', '16', '22', '160', 
                                  '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('13', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', '16', '10', '22', '16', '16', '22', '160', 
                                  '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('14', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', '16', '22', '10', '16', '16', '22', '160', 
                                  '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('15', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', '22', '16', '16', '10', '22', '16', '160', 
                                  '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('16', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', '16', '16', '16', '22', '10', '16', '160', 
                                  '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('17', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', '22', '22', '22', '16', '16', '10', '160', 
                                  '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200')"""
        self.execute_db(insertString + ")" + valueString)

        # ServerNode 4
        valueString = """ VALUES ('18', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', 
                                  '10', '16', '16', '22', '16', '22', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('19', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', 
                                  '16', '10', '22', '16', '16', '22', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('20', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', 
                                  '16', '22', '10', '16', '16', '22', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('21', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', 
                                  '22', '16', '16', '10', '22', '16', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('22', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', 
                                  '16', '16', '16', '22', '10', '16', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('23', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', 
                                  '22', '22', '22', '16', '16', '10', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160')"""
        self.execute_db(insertString + ")" + valueString)

        # ServerNode 5
        valueString = """ VALUES ('24', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', 
                                  '200', '200', '200', '200', '200', '200', '10', '16', '16', '22', '16', '22', '160', '160', '160', '160', '160', '160 ')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('25', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', 
                                  '200', '200', '200', '200', '200', '200', '16', '10', '22', '16', '16', '22', '160', '160', '160', '160', '160', '160 ')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('26', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', 
                                  '200', '200', '200', '200', '200', '200', '16', '22', '10', '16', '16', '22', '160', '160', '160', '160', '160', '160 ')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('27', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', 
                                  '200', '200', '200', '200', '200', '200', '22', '16', '16', '10', '22', '16', '160', '160', '160', '160', '160', '160 ')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('28', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', 
                                  '200', '200', '200', '200', '200', '200', '16', '16', '16', '22', '10', '16', '160', '160', '160', '160', '160', '160 ')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('29', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', 
                                  '200', '200', '200', '200', '200', '200', '22', '22', '22', '16', '16', '10', '160', '160', '160', '160', '160', '160')"""
        self.execute_db(insertString + ")" + valueString)

        # ServerNode 6
        valueString = """ VALUES ('30', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', 
                                  '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '10', '16', '16', '22', '16', '22')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('31', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', 
                                  '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '16', '10', '22', '16', '16', '22')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('32', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', 
                                  '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '16', '22', '10', '16', '16', '22')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('33', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', 
                                  '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '22', '16', '16', '10', '22', '16')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('34', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', 
                                  '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '16', '16', '16', '22', '10', '16')"""
        self.execute_db(insertString + ")" + valueString)
        valueString = """ VALUES ('35', '200', '200', '200', '200', '200', '200', '160', '160', '160', '160', '160', '160', '200', '200', '200', '200', '200', '200', 
                                  '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '160', '22', '22', '22', '16', '16', '10')"""
        self.execute_db(insertString + ")" + valueString)


dis=  Numadistance()
print (str(dis.getNumaDistance(0,0))+"\n")
print (str(dis.getNumaDistance(1,1))+"\n")
print (str(dis.getNumaDistance(1,0))+"\n")
print (str(dis.getNumaDistance(1,2))+"\n")
print (str(dis.getNumaDistance(1,3))+"\n")
print (str(dis.getNumaDistance(1,30))+"\n")